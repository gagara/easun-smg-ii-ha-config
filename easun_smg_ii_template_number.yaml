- name: Max Charging Current
  unique_id: smgii1_maximum_charging_current
  state: "{{ states('sensor.maximum_charging_current') }}"
  min: "{{ [2, states('sensor.maximum_mains_charging_current')|int(2)]|max }}"
  max: 80
  step: 1
  availability: "{{ not states('sensor.maximum_charging_current') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 640
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Max Mains Charging Current
  unique_id: smgii1_maximum_mains_charging_current
  state: "{{ states('sensor.maximum_mains_charging_current') }}"
  min: 2
  max: "{{ [60, states('sensor.maximum_charging_current')|int(60)]|min }}"
  step: 1
  availability: "{{ not states('sensor.maximum_mains_charging_current') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 641
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Battery Low Voltage Protection
  unique_id: smgii1_battery_low_voltage_protection
  state: "{{ states('sensor.battery_low_voltage_protection') }}"
  min: 40
  max: "{{ [54, states('sensor.battery_back_to_grid_voltage')|float(54.1)-0.1]|min }}"
  step: 0.1
  availability: "{{ not states('sensor.battery_low_voltage_protection') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 646
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Battery Back to Grid Voltage
  unique_id: smgii1_battery_back_to_grid_voltage
  state: "{{ states('sensor.battery_back_to_grid_voltage') }}"
  min: "{{ [44, states('sensor.battery_low_voltage_protection')|float(43.9)+0.1]|max }}"
  max: "{{ [54, states('sensor.battery_mains_high_voltage')|float(54.1)-0.1]|min }}"
  step: 0.1
  availability: "{{ not states('sensor.battery_back_to_grid_voltage') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 644
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Battery Back to OffGrid Voltage
  unique_id: smgii1_battery_back_to_offgrid_voltage
  state: "{{ states('sensor.battery_back_to_offgrid_voltage') }}"
  min: "{{ [48, states('sensor.battery_back_to_grid_voltage')|float(47.9)+0.1]|max }}"
  max: "{{ [62, states('sensor.max_charging_voltage')|float(62)-0.5]|min }}"
  step: 0.1
  availability: "{{ not states('sensor.battery_back_to_offgrid_voltage') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 643
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Max Charging Voltage
  unique_id: smgii1_max_charging_voltage
  state: "{{ states('sensor.max_charging_voltage') }}"
  min: "{{ [48, states('sensor.floating_charging_voltage')|float(48)]|max }}"
  max: "{{ [62, states('sensor.battery_overvoltage_protection_point')|float(62)-4]|min }}"
  step: 0.1
  availability: "{{ not states('sensor.max_charging_voltage') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 637
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Floating Charging Voltage
  unique_id: smgii1_floating_charging_voltage
  state: "{{ states('sensor.floating_charging_voltage') }}"
  min: 48
  max: "{{ [64, states('sensor.max_charging_voltage')|float(64)]|min }}"
  step: 0.1
  availability: "{{ not states('sensor.floating_charging_voltage') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 325
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Constant Pressure to Float Waiting Time
  unique_id: smgii1_constant_pressure_to_float_waiting_time
  state: "{{ states('sensor.constant_pressure_to_float_waiting_time') }}"
  min: 0
  max: 900
  step: 1
  availability: "{{ not states('sensor.constant_pressure_to_float_waiting_time') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 639
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"

- name: Battery Overvoltage Protection Point
  unique_id: smgii1_battery_overvoltage_protection_point
  state: "{{ states('sensor.battery_overvoltage_protection_point') }}"
  min: "{{ [56, states('sensor.max_charging_voltage')|float(56)]|max }}"
  max: 66
  step: 0.1
  availability: "{{ not states('sensor.battery_overvoltage_protection_point') in ['unavailable', 'unknown', 'none'] }}"
  set_value:
    - service: modbus.write_register
      data:
        address: 631
        unit: 1
        hub: easun_smg_ii
        value: "{{ [value * 10] }}"
